stages:
  # - test
  - deploy

# unit-test-job:   # This job runs in the test stage.
#   stage: test    # It only starts when the job in the build stage completes successfully.
#   script:
#     - echo "Running unit tests... This will take about 60 seconds."
#     - sleep 60
#     - echo "Code coverage is 90%"

# lint-test-job:   # This job also runs in the test stage.
#   stage: test    # It can run at the same time as unit-test-job (in parallel).
#   script:
#     - echo "Linting code... This will take about 10 seconds."
#     - sleep 10
#     - echo "No lint issues found."

deploy:      # This job runs in the deploy stage.
  image: ruby:3.1.1
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  before_script:
  - gem install dpl
  - wget -qO- https://cli-assets.heroku.com/install-ubuntu.sh | sh
  script:
    - echo -en $"ENVIRONMENT=staging\nSECRET_KEY=$1" > .env
    # - make venv
    # - source ~/.zshrc
    - pwd;
    - whoami
    - which $SHELL
    - which dpl
    - dpl --provider=heroku --app=$HEROKU_APPNAME --api-key=$HEROKU_APIKEY --skip-cleanup
    - export HEROKU_API_KEY=$HEROKU_APIKEY
  environment:
    name: staging
    url: $HEROKU_APP_HOST
  only: 
    - main
  tags:
    - dockerRunner
